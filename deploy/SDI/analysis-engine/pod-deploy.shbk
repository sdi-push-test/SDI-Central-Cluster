#!/bin/bash

# SDI Analysis Engine Kubernetes Pod Deployment Script
# Usage: ./pod-deploy.sh [deploy|delete|restart|logs|status|build|exec]

set -e

APP_NAME="sdi-analysis-engine"
DOCKER_REGISTRY="ketidevit2"
IMAGE_BASE="sdi-analysis-engine"
VERSION="v0.0.6"
IMAGE_NAME="${DOCKER_REGISTRY}/${IMAGE_BASE}:${VERSION}"
NAMESPACE="default"
DEPLOYMENT_FILE="sdi_anlysis_engine.yaml"

function usage() {
    echo "ì‚¬ìš©ë²•: $0 [deploy|delete|restart|logs|status|build|push|update-version|full-deploy|exec|port-forward]"
    echo ""
    echo "í˜„ì¬ ì„¤ì •:"
    echo "  ì´ë¯¸ì§€: $IMAGE_NAME"
    echo "  ë°°í¬ íŒŒì¼: $DEPLOYMENT_FILE"
    echo ""
    echo "ëª…ë ¹ì–´:"
    echo "  deploy         - íŒŒë“œ ë°°í¬ (kubectl applyë§Œ)"
    echo "  full-deploy    - ì „ì²´ ë°°í¬ (ë¹Œë“œ + í‘¸ì‹œ + ë²„ì „ì—…ë°ì´íŠ¸ + ë°°í¬)"
    echo "  delete         - íŒŒë“œ ì‚­ì œ"
    echo "  restart        - íŒŒë“œ ì¬ì‹œì‘"
    echo "  logs           - íŒŒë“œ ë¡œê·¸ í™•ì¸ (ì‹¤ì‹œê°„)"
    echo "  status         - íŒŒë“œ ìƒíƒœ í™•ì¸"
    echo "  build          - ë„ì»¤ ì´ë¯¸ì§€ë§Œ ë¹Œë“œ"
    echo "  push           - ë„ì»¤ ì´ë¯¸ì§€ í‘¸ì‹œ (ë¹Œë“œ í¬í•¨)"
    echo "  update-version - YAML íŒŒì¼ì˜ ì´ë¯¸ì§€ ë²„ì „ ì—…ë°ì´íŠ¸"
    echo "  exec           - íŒŒë“œì— ì ‘ì†"
    echo "  port-forward   - ë¡œì»¬ í¬íŠ¸ í¬ì›Œë”© (50051:50051)"
    echo "  describe       - íŒŒë“œ ìƒì„¸ ì •ë³´"
    echo ""
    echo "ìƒˆë¡œìš´ etcd ë¶„ì„ ê¸°ëŠ¥:"
    echo "  â€¢ ì¼ë°˜ ëª¨ë“œ: InfluxDB + etcd í†µí•© ëª¨ë‹ˆí„°ë§"
    echo "  â€¢ etcd ì „ìš©: docker run -e ETCD_HOST=your-etcd $IMAGE_NAME --etcd-monitor"
    echo "  â€¢ í…ŒìŠ¤íŠ¸: docker run $IMAGE_NAME --test"
}

function build_image() {
    echo "ğŸ”¨ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
    echo "   ì´ë¯¸ì§€: $IMAGE_NAME"
    docker build -t $IMAGE_NAME .
    echo "âœ… ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ: $IMAGE_NAME"
}

function push_image() {
    echo "ğŸ“¤ Docker ì´ë¯¸ì§€ í‘¸ì‹œ ì¤‘..."
    
    # ë¨¼ì € ë¹Œë“œ
    build_image
    
    # Docker Hubì— í‘¸ì‹œ
    echo "ğŸš€ Docker Hubì— ì´ë¯¸ì§€ í‘¸ì‹œ ì¤‘..."
    echo "   ì´ë¯¸ì§€: $IMAGE_NAME"
    docker push $IMAGE_NAME
    echo "âœ… ì´ë¯¸ì§€ í‘¸ì‹œ ì™„ë£Œ!"
}

function update_yaml_version() {
    echo "ğŸ“ YAML íŒŒì¼ ë²„ì „ ì—…ë°ì´íŠ¸ ì¤‘..."
    echo "   íŒŒì¼: $DEPLOYMENT_FILE"
    echo "   ì´ë¯¸ì§€: $IMAGE_NAME"
    
    if [ ! -f "$DEPLOYMENT_FILE" ]; then
        echo "âŒ ë°°í¬ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $DEPLOYMENT_FILE"
        exit 1
    fi
    
    # sedë¥¼ ì‚¬ìš©í•´ì„œ ì´ë¯¸ì§€ ë²„ì „ ì—…ë°ì´íŠ¸
    sed -i.bak "s|image: ${DOCKER_REGISTRY}/${IMAGE_BASE}:.*|image: ${IMAGE_NAME}|g" $DEPLOYMENT_FILE
    
    echo "âœ… YAML íŒŒì¼ ì—…ë°ì´íŠ¸ ì™„ë£Œ!"
    echo "   ë°±ì—… íŒŒì¼: ${DEPLOYMENT_FILE}.bak"
    
    # ë³€ê²½ì‚¬í•­ í™•ì¸
    echo "ğŸ“‹ ë³€ê²½ëœ ì´ë¯¸ì§€ ì •ë³´:"
    grep "image: ${DOCKER_REGISTRY}/${IMAGE_BASE}" $DEPLOYMENT_FILE || echo "   ì´ë¯¸ì§€ ë¼ì¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
}

function full_deploy() {
    echo "ğŸš€ SDI Analysis Engine ì „ì²´ ë°°í¬ ì‹œì‘..."
    echo "   ë²„ì „: $VERSION"
    echo "   ì´ë¯¸ì§€: $IMAGE_NAME"
    echo ""
    
    # 1. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    echo "=== 1ë‹¨ê³„: Docker ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ ==="
    push_image
    echo ""
    
    # 2. YAML íŒŒì¼ ë²„ì „ ì—…ë°ì´íŠ¸
    echo "=== 2ë‹¨ê³„: YAML íŒŒì¼ ë²„ì „ ì—…ë°ì´íŠ¸ ==="
    update_yaml_version
    echo ""
    
    # 3. Kubernetes ë°°í¬
    echo "=== 3ë‹¨ê³„: Kubernetes ë°°í¬ ==="
    deploy_pod
    
    echo ""
    echo "ğŸ‰ ì „ì²´ ë°°í¬ ì™„ë£Œ!"
    echo "   ì´ë¯¸ì§€: $IMAGE_NAME"
    echo "   ë°°í¬ íŒŒì¼: $DEPLOYMENT_FILE"
}

function deploy_pod() {
    echo "ğŸš€ Kubernetesì— íŒŒë“œ ë°°í¬ ì¤‘..."
    echo "   ë°°í¬ íŒŒì¼: $DEPLOYMENT_FILE"
    
    # ë°°í¬ íŒŒì¼ ì¡´ì¬ í™•ì¸
    if [ ! -f "$DEPLOYMENT_FILE" ]; then
        echo "âŒ ë°°í¬ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $DEPLOYMENT_FILE"
        exit 1
    fi
    
    # ê¸°ì¡´ ë°°í¬ ì‚­ì œ (ìˆë‹¤ë©´)
    echo "ğŸ—‘ï¸  ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì¤‘..."
    kubectl delete -f $DEPLOYMENT_FILE --ignore-not-found=true
    echo "â³ ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ëŒ€ê¸° ì¤‘..."
    sleep 5
    
    # ìƒˆ ë°°í¬ ìƒì„±
    echo "ğŸ“¦ ìƒˆ ë¦¬ì†ŒìŠ¤ ë°°í¬ ì¤‘..."
    kubectl apply -f $DEPLOYMENT_FILE
    
    echo "â³ íŒŒë“œ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
    kubectl wait --for=condition=ready pod -l app=$APP_NAME --timeout=120s
    
    echo "âœ… íŒŒë“œ ë°°í¬ ì™„ë£Œ!"
    echo ""
    show_status
    echo ""
    echo "ğŸ“Š ì„œë¹„ìŠ¤ ì ‘ì† ì •ë³´:"
    echo "   - gRPC: localhost:30051 (NodePort)"
    echo "   - í¬íŠ¸ í¬ì›Œë”©: ./pod-deploy.sh port-forward"
}

function delete_pod() {
    echo "ğŸ›‘ SDI Analysis Engine íŒŒë“œ ì‚­ì œ ì¤‘..."
    kubectl delete -f $DEPLOYMENT_FILE --ignore-not-found=true
    echo "âœ… íŒŒë“œ ì‚­ì œ ì™„ë£Œ!"
}

function restart_pod() {
    echo "ğŸ”„ SDI Analysis Engine íŒŒë“œ ì¬ì‹œì‘ ì¤‘..."
    kubectl rollout restart deployment/$APP_NAME -n $NAMESPACE
    kubectl rollout status deployment/$APP_NAME -n $NAMESPACE
    echo "âœ… íŒŒë“œ ì¬ì‹œì‘ ì™„ë£Œ!"
}

function show_logs() {
    echo "ğŸ“‹ íŒŒë“œ ë¡œê·¸ (ì‹¤ì‹œê°„):"
    echo "   Ctrl+Cë¡œ ì¢…ë£Œ"
    echo ""
    kubectl logs -f -l app=$APP_NAME -n $NAMESPACE --tail=50
}

function show_status() {
    echo "ğŸ“Š íŒŒë“œ ìƒíƒœ:"
    kubectl get pods -l app=$APP_NAME -n $NAMESPACE -o wide
    echo ""
    echo "ğŸ“Š ì„œë¹„ìŠ¤ ìƒíƒœ:"
    kubectl get svc -l app=$APP_NAME -n $NAMESPACE
    echo ""
    echo "ğŸ“Š ë°°í¬ ìƒíƒœ:"
    kubectl get deployment $APP_NAME -n $NAMESPACE
}

function exec_pod() {
    POD_NAME=$(kubectl get pods -l app=$APP_NAME -n $NAMESPACE -o jsonpath='{.items[0].metadata.name}')
    if [ -z "$POD_NAME" ]; then
        echo "âŒ ì‹¤í–‰ ì¤‘ì¸ íŒŒë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        exit 1
    fi
    
    echo "ğŸ”— íŒŒë“œì— ì ‘ì† ì¤‘: $POD_NAME"
    kubectl exec -it $POD_NAME -n $NAMESPACE -- /bin/bash
}

function port_forward() {
    POD_NAME=$(kubectl get pods -l app=$APP_NAME -n $NAMESPACE -o jsonpath='{.items[0].metadata.name}')
    if [ -z "$POD_NAME" ]; then
        echo "âŒ ì‹¤í–‰ ì¤‘ì¸ íŒŒë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        exit 1
    fi
    
    echo "ğŸŒ í¬íŠ¸ í¬ì›Œë”© ì‹œì‘: localhost:50051 -> $POD_NAME:50051"
    echo "   Ctrl+Cë¡œ ì¢…ë£Œ"
    kubectl port-forward $POD_NAME 50051:50051 -n $NAMESPACE
}

function describe_pod() {
    POD_NAME=$(kubectl get pods -l app=$APP_NAME -n $NAMESPACE -o jsonpath='{.items[0].metadata.name}')
    if [ -z "$POD_NAME" ]; then
        echo "âŒ ì‹¤í–‰ ì¤‘ì¸ íŒŒë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        exit 1
    fi
    
    echo "ğŸ“‹ íŒŒë“œ ìƒì„¸ ì •ë³´: $POD_NAME"
    kubectl describe pod $POD_NAME -n $NAMESPACE
}

# kubectl ì„¤ì¹˜ í™•ì¸
if ! command -v kubectl &> /dev/null; then
    echo "âŒ kubectlì´ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."
    echo "   ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„°ì— ì ‘ê·¼í•˜ë ¤ë©´ kubectlì´ í•„ìš”í•©ë‹ˆë‹¤."
    exit 1
fi

# ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„° ì—°ê²° í™•ì¸
if ! kubectl cluster-info &> /dev/null; then
    echo "âŒ ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„°ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
    echo "   kubectl configë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
    exit 1
fi

case "${1:-full-deploy}" in
    deploy)
        deploy_pod
        ;;
    full-deploy)
        full_deploy
        ;;
    delete)
        delete_pod
        ;;
    restart)
        restart_pod
        ;;
    logs)
        show_logs
        ;;
    status)
        show_status
        ;;
    build)
        build_image
        ;;
    push)
        push_image
        ;;
    update-version)
        update_yaml_version
        ;;
    exec)
        exec_pod
        ;;
    port-forward)
        port_forward
        ;;
    describe)
        describe_pod
        ;;
    *)
        usage
        exit 1
        ;;
esac
